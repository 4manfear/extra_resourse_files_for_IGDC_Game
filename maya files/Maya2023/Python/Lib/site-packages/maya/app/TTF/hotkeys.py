from maya.app.flux.imports import *
import maya.app.TTF.utils as dUtils
import maya.app.TTF.api
dm = lambda: maya.app.TTF.api.dataManager()

class HotkeyFilter(qt.QObject):
    def __init__(self, window):
        qt.QObject.__init__(self)
        self.window = window

    def eventFilter(self, widget, event):
        window = self.window
        
        if (event.type() == qt.QEvent.KeyPress and widget is window.newHelpView.helpView):
            key = event.key()

            if key == qt.Qt.Key_Up:
                window.focusTTFInput()
                return True

            if key == qt.Qt.Key_Left or key == qt.Qt.Key_Alt:
                window.focusTTFInput()
                window.switchHelp()
                return True

            if key == qt.Qt.Key_Right:
                return True

            window.focusTTFInput()
            window.forwardEventToInput(event)
            return True

        if (event.type() == qt.QEvent.KeyPress and widget is window.lineEdit):
            key = event.key()
            modifiers = qt.QGuiApplication.keyboardModifiers()
            isControlDown = modifiers & qt.Qt.ControlModifier
            isShiftDown = modifiers & qt.Qt.ShiftModifier

            nav = None
            if key == qt.Qt.Key_Up:
                nav = -1
            if key == qt.Qt.Key_Down:
                if window.isHelpVisible:
                    window.newHelpView.helpView.setFocus()
                    return True

                nav = 1
            if nav:
                if not window.isHelpVisible: window.navigateUpDown(nav)
                return True

            if key == qt.Qt.Key_Right and window.getSelectedCommand():
                if dm().getContext() != 'select':
                    window.switchHelp()
                    return True

            if key == qt.Qt.Key_Left and window.getSelectedCommand():
                if dm().getContext() != 'select':
                    return True

            if key == qt.Qt.Key_Alt:
                if dm().getContext() != 'select':
                    window.switchHelp()
                return True
                
            if key == qt.Qt.Key_Tab:
                window.autocomplete()
                return True

            # prevent loss of focus
            if key == qt.Qt.Key_Shift:
                return True               

            if key == qt.Qt.Key_Return and isShiftDown:
                window.openSelectedOptionBox()
                return True

            if key == qt.Qt.Key_Return:
                window.executeCommand()
                return True

            if (key == qt.Qt.Key_Backspace and window.lineEdit.cursorPosition() == 0 
                and not window.lineEdit.hasSelectedText()):
                window.deleteTag()
                return True

            if (key == qt.Qt.Key_S and isControlDown):
                if len(window.lineEdit.text())>0 or window.getSelectedCommand() is not None:
                    window.toggleFavorite()
                return True

            if (key == qt.Qt.Key_D and isControlDown):
                newContext = 1
                if dm().getContext() == 'python':
                    newContext = 2

                dm().setContextId(newContext)
                window.updateContext()
                return True

            if (key == qt.Qt.Key_B and isControlDown):
                window.showDocs()
                return True

            if (key == qt.Qt.Key_G and isControlDown):
                window.clearText()
                return True            

            if (key == qt.Qt.Key_T and isControlDown):
                dUtils.printSelectionStatistics()
                return True  

        return False# ===========================================================================
# Copyright 2022 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
