import maya
maya.utils.loadStringResourcesForModule(__name__)

import maya.internal.common.ae.template as aetemplate

import maya.internal.common.ae.custom as aecustom
import maya.internal.common.utils.ui as ui_utils
import maya.cmds

from PySide2 import QtWidgets, QtCore, QtGui

labelDeformerWeightOff = maya.stringTable['y_maya_internal_nodes_vertexcolors_ae_template.kDeformerWeightOff' ]

class DeformerWeightsControl(aecustom.CustomControl):

    def buildControlUI(self):
        parent = maya.cmds.setParent(q=True)
        self.deformerMenu = ui_utils.DynamicOptionMenu(label=maya.stringTable['y_maya_internal_nodes_vertexcolors_ae_template.kDeformerWeights' ],
                                                       candidateFn=self._getDeformers,
                                                       pickedFn=self._selectDeformer)
        maya.cmds.setParent(parent)
        self.updateWidgets()

    def replaceControlUI(self):
        self.updateWidgets()

    def _getDeformers(self, *args):
        deformers = maya.cmds.deformableShape(self.nodeName, ch=True)
        d = [labelDeformerWeightOff]
        d.extend(deformers)
        return d

    def _selectDeformer(self, *args):
        d = args[0]
        if d == labelDeformerWeightOff:
            maya.cmds.weightsColor(self.nodeName, fc=False)
        else:
            maya.cmds.weightsColor(self.nodeName, dfm=d, fc=True)

        self.deformerMenu.setValue(d)

    def updateWidgets(self):
        d = maya.cmds.weightsColor(self.nodeName, q=True, dfm=True)[0]
        self.deformerMenu.setValue(d if d else labelDeformerWeightOff)

# --------------------------------------------------------------------------------------------------------------
class AETemplate(aetemplate.Template):
    def __init__(self, nodeName):
        self.nodeName = nodeName
        self.buildUI(nodeName)

    def buildUI(self, nodeName):
        self.addControls(['currentUVSet',
                        'currentColorSet',
                        'motionVectorColorSet',
                        'vertexColorSource'])

        self.defineCustom(DeformerWeightsControl(), ['displayDeformerWeights'])



# ===========================================================================
# Copyright 2022 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
