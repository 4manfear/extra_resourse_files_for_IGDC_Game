'''
UFE instruction on how to create a control for a enum attribute.

Read the Readme.md for further information
'''

import maya.cmds as cmds
import maya.internal.ufeSupport.attributes as attributes

def updateUi(attr, uiControlName):
    '''Callback function to update the UI when the data model changes.'''
    try:
        # If you edit the value directly (using the runtime) and set the enum
        # to a non-known value while the AE was open Maya will throw an error
        # here. The reason is the newly entered value is not in the list of
        # choices of the optionMenuGrp.
        cmds.optionMenuGrp(uiControlName, edit=True, value=attr.get())
    except RuntimeError:
        pass

    # Update the appearance and read-only status of control(s).
    isLocked = attributes.isAttributeLocked(attr)
    cmds.optionMenu(uiControlName+"|OptionMenu", e=True, enable=not isLocked)

def replace(controlName, ufeAttr, attrUIName, changedCommand):
    attachMenuItems(controlName, ufeAttr)
    updateUi(ufeAttr, controlName)
    cmds.optionMenuGrp(controlName, e=True, label=attrUIName)
    attachCallbacks(ufeAttr, controlName, changedCommand)

def attachMenuItems(uiControl, ufeAttr):
    attrValue = ufeAttr.get()
    attrTokens = ufeAttr.getEnumValues()

    if attrValue not in attrTokens:
        attrTokens.insert(0, attrValue)

    cmds.optionMenuGrp(uiControl, edit=True, deleteAllItems=True)
    for item in attrTokens:
        cmds.menuItem(parent=(uiControl +'|OptionMenu'), label=item)

def create(ufeAttr, attrUIName, changedCommand):
    # Create the control.
    uiControl = cmds.optionMenuGrp(label=attrUIName)
    pMenu = attributes.AEPopupMenu(uiControl, ufeAttr)

    # Add the menu items.
    attachMenuItems(uiControl, ufeAttr)

    # Set the value.
    updateUi(ufeAttr, uiControl)

    attachCallbacks(ufeAttr, uiControl, changedCommand)

    return uiControl

def attachCallbacks(ufeAttr, uiControl, changedCommand):
    # Create change callback for UFE and UI value synchronization.
    cb = attributes.createChangeCb(updateUi, ufeAttr, uiControl)
    cmds.optionMenuGrp(uiControl, edit=True, changeCommand=cb)

# ===========================================================================
# Copyright 2022 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
