import maya.cmds

class NodeCountInfo(object):
    """
    Simple class to count the number of nodes of different types in a
    a scene at 2 moments and compare the difference
    """
    def __init__(self, capture=True):
        self._skipNodeTypes = { 'containerBase', 'geometryFilter' }
        if capture:
            self.captureStart()

    def captureAndAnalyze(self):
        self.captureEnd()
        self.analyze()

    def _captureNodeTypeCount(self):
        d = dict()
        allTypes = maya.cmds.allNodeTypes()
        for nt in allTypes:
            if nt in self._skipNodeTypes:
                continue

            nodes = maya.cmds.ls(type=nt)
            d[nt] = len(nodes)
        return d

    def captureStart(self):
        self.startNodeTypeCount = self._captureNodeTypeCount()
        self.startCount = len(maya.cmds.ls())

    def captureEnd(self):
        self.endNodeTypeCount = self._captureNodeTypeCount()
        self.endCount = len(maya.cmds.ls())

    def analyze(self):
        self.diffNodeTypes = list()
        allKeys = set(self.startNodeTypeCount.keys())
        allKeys = allKeys.union(set(self.endNodeTypeCount.keys()))

        sortedKeys = sorted(list(allKeys))

        diffCnt = 0
        for k in sortedKeys:
            n0 = self.startNodeTypeCount.get(k, 0)
            n1 = self.endNodeTypeCount.get(k, 0)
            if n0 != n1:
                self.diffNodeTypes.append( (k, n0, n1) )

    def _reportLine(self, name, n0, n1):
        nameFt = '%30s'
        numFt = '%8d'
        return '{} : {} | {} | {}'.format(nameFt%name, numFt%n0, numFt%n1, numFt%(n1-n0))

    def printReport(self):
        print ()
        print (self._reportLine('Total', self.startCount, self.endCount))
        print ('-'*(33+3*10))

        for d in self.diffNodeTypes:
            k, n0, n1 = d
            print (self._reportLine(k, n0, n1))
        print ()

# ===========================================================================
# Copyright 2022 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
