import maya
maya.utils.loadStringResourcesForModule(__name__)

'''
Maya Instruction on how to create a control for a message attribute

Read the Readme.md for further information
'''

import maya.cmds as cmds
import maya.mel as mel
from . import template

def update(controlName, plugName):
    connections = cmds.listConnections(plugName)
    txt = connections[0] if connections else ""
    cmds.textFieldGrp(controlName, e=True, tx=txt)
    if txt != "":
        cmds.textFieldButtonGrp(controlName, e=True,
                                bl=" > ",
                                bc=lambda *_a: mel.eval("%s %s"%("showEditor", connections[0])))
    else:
        cmds.textFieldButtonGrp(controlName, e=True, eb=False, bl=maya.stringTable['y_maya_internal_common_ae_message.kMap' ], bc="")

def replace(controlName, plugName, attrName, changedCommand):
    update(controlName, plugName)
    # reattach the scriptJob to the new plug
    cmds.scriptJob(p=controlName, rp=True, ac=(plugName, lambda *_a: update(controlName, plugName)))

    # update the changedCommand
    if changedCommand:
        cmds.textFieldButtonGrp(controlName, e=True, cc=lambda *_a:changedCommand(template.plugNode(plugName)))


def create(plugName, attrName, changedCommand):
    node = template.plugNode(plugName)
    # special control for mental ray node
    if template.isClassified(node, "rendernode/mentalray"):
        #TODO: replace that mel eval by porting AEmentalrayNewMessage to python
        return mel.eval("AEmentalrayNewMessage(%s,%s,%s)"% (plugName, attrName, changedCommand))


    createdControl = cmds.textFieldButtonGrp(l=attrName)
    update(createdControl,plugName)

    # connect the control
    template.attachCallback(plugName, createdControl, (lambda *_a: update(createdControl, plugName)))


    # only make the text field editable if there is a changedCommand
    # to handle it
    if changedCommand:
        cmds.textFieldButtonGrp(createdControl, e=True,
                                cc=lambda *_a:changedCommand(node))
    else:
        cmds.textFieldGrp(createdControl, e=True, ed=False)

    return createdControl
# ===========================================================================
# Copyright 2022 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
