'''
UFE instruction on how to create a control for a color attribute.

Read the Readme.md for further information
'''

import ufe
import maya.cmds as cmds
import maya.internal.ufeSupport.attributes as attributes

def updateUi(attr, uiControlName):
    '''Callback function to update the UI when the data model changes.'''
    cmds.colorSliderGrp(uiControlName, e=True, rgb=(attr.get().color))

    # Update the appearance and read-only status of control(s).
    isLocked = attributes.isAttributeLocked(attr)
    cmds.control(uiControlName+"|port", e=True, enable=not isLocked)
    cmds.floatSlider(uiControlName+"|slider", e=True, enable=not isLocked)

def updateDataReader(*values, **kwargs):
    '''Read data from UI when updating UFE data model

    For most UI controls, the change command callback is called with the
    updated UI values passed into the callback through the values positional
    arguments tuple.  Strangely and uselessly, the colorSliderGrp change
    command callback is called with a single-element tuple, and the element is
    an empty string.

    The workaround is simply to read the UI value from the UI control itself,
    which is passed in as the 'uiControl' keyword argument.
    '''
    uiControl = kwargs['uiControl']
    color = cmds.colorSliderGrp(uiControl, query=True, rgb=True)
    uiColor = ufe.Color3f(*color)
    ufeAttr = kwargs['ufeAttr']
    ufeColor = ufeAttr.get()
    # If unchanged, return None and don't generate a command.
    return None if ufeColor.color == uiColor.color else uiColor

def replace(controlName, ufeAttr, attrUIName, changedCommand):
    updateUi(ufeAttr, controlName)
    cmds.colorSliderGrp(controlName, e=True, label=attrUIName)
    attachCallbacks(ufeAttr, controlName, changedCommand)

def create(ufeAttr, attrUIName, changedCommand):
    uiControl = cmds.colorSliderGrp(label=attrUIName)
    pMenu = attributes.AEPopupMenu(uiControl, ufeAttr)
    updateUi(ufeAttr, uiControl)
    attachCallbacks(ufeAttr, uiControl, changedCommand)

    return uiControl

def attachCallbacks(ufeAttr, uiControl, changedCommand):
    # Create change callback for UFE and UI value synchronization.
    cb = attributes.createChangeCb(
        updateUi, ufeAttr, uiControl, updateDataReader=updateDataReader)
    cmds.colorSliderGrp(uiControl, edit=True, changeCommand=cb)

# ===========================================================================
# Copyright 2022 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
