"""
    Helper to start the overlay system in Maya
"""

from __future__ import absolute_import

# qt
from PySide2 import QtWidgets, QtCore
import maya.cmds as cmds
from PySide2 import QtWidgets
import shiboken2

# maya
import maya.OpenMayaUI as omui

# internal
from . import OverlayManager

from typing import Dict

theOverlayManager = None


def getMainMayaWindow():
    """ returns the main maya window """
    ptr = omui.MQtUtil.mainWindow()
    return shiboken2.wrapInstance(int(ptr), QtWidgets.QMainWindow)


def overlayManager():
    """ gets or create the maya overlay manager """
    global theOverlayManager
    if theOverlayManager is None:
        theOverlayManager = OverlayManager(getMainMayaWindow())
    return theOverlayManager


class DockControlInfo:
    def __init__(self, name="", rect=QtCore.QRect(), visible=True, widget=None):
        self.name = name
        self.rect = rect
        self.visible = visible
        self.widget = widget

    def __str__(self):
        return self.name + "  " + str(self.rect) + "  " + str(self.visible) + "  " + str(self.widget)


def findAlWorkspaceControls():
    allControl = cmds.lsUI(type="workspaceControl")
    visibleControls = dict()  # type: Dict[str, DockControlInfo]

    mainWindow = getMainMayaWindow()
    parentTopLeft = mainWindow.frameGeometry().topLeft()

    for ctl in allControl:

        widgetptr = omui.MQtUtil.findControl(ctl)
        widget = shiboken2.wrapInstance(int(widgetptr), QtWidgets.QWidget)
        rect = widget.rect()
        screenRect = QtCore.QRect()
        screenRect.setTopLeft(widget.mapToGlobal(rect.topLeft()))
        screenRect.setSize(rect.size())
        visible = cmds.workspaceControl(ctl, query=True, visible=1)
        screenRect.translate(-parentTopLeft.x(), -parentTopLeft.y())

        dockInfo = DockControlInfo(
            name=ctl, rect=screenRect, visible=visible, widget=widget)

        visibleControls[ctl] = dockInfo
    return visibleControls
# ===========================================================================
# Copyright 2022 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
